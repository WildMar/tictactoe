import pytest

from controller import Play


@pytest.mark.parametrize("board, winner", [
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], None),
    ([["O", "O", "O"],
      ["___", "___", "___"],
      ["___", "___", "___"]], "O"),
    ([["___", "___", "___"],
      ["O", "O", "O"],
      ["___", "___", "___"]], "O"),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["O", "O", "O"]], "O"),
    ([["O", "___", "___"],
      ["___", "O", "___"],
      ["___", "___", "O"]], "O"),
    ([["___", "___", "O"],
      ["___", "O", "___"],
      ["O", "___", "___"]], "O"),
    ([["O", "___", "___"],
      ["O", "___", "___"],
      ["O", "___", "___"]], "O"),
    ([["___", "O", "___"],
      ["___", "O", "___"],
      ["___", "O", "___"]], "O"),
    ([["___", "___", "O"],
      ["___", "___", "O"],
      ["___", "___", "O"]], "O"),
    ([["O", "___", "___"],
      ["O", "O", "___"],
      ["___", "___", "___"]], None),
    ([["X", "O", "X"],
      ["X", "O", "X"],
      ["O", "X", "O"]], None),
])
def test_check_win(board, winner):
    assert Play(board=board, move_number=9, player="X").check_win() == winner


@pytest.mark.parametrize("board, is_draw", [
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], False),
    ([["O", "O", "O"],
      ["___", "___", "___"],
      ["___", "___", "___"]], False),
    ([["O", "X", "X"],
      ["O", "X", "O"],
      ["X", "O", "X"]], True)])
def test_draw(board, is_draw):
    assert Play(board=board, move_number=9, player="X").check_draw() == is_draw


@pytest.mark.parametrize("board, expected_return", [
    ([["O", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], None),
    ([["___", "___", "O"],
      ["___", "___", "___"],
      ["___", "___", "___"]], None),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["O", "___", "___"]], None),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "O"]], None),
    ([["___", "___", "___"],
      ["___", "O", "___"],
      ["___", "___", "___"]], None),
    ([["___", "O", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], [["___", "O", "___"], ["___", "___", "___"], ["X", "___", "___"]]),
    ([["___", "___", "___"],
      ["O", "___", "___"],
      ["___", "___", "___"]], [["___", "___", "X"], ["O", "___", "___"], ["___", "___", "___"]]),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["___", "O", "___"]], [["X", "___", "___"], ["___", "___", "___"], ["___", "O", "___"]]),
    ([["___", "___", "___"],
      ["___", "___", "O"],
      ["___", "___", "___"]], [["X", "___", "___"], ["___", "___", "O"], ["___", "___", "___"]])
])
def test_check_edges(board, expected_return):
    assert Play(board=board, move_number=9, player="X")._check_edges() == expected_return


@pytest.mark.parametrize("board, x, y", [
    ([["O", "O", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 0, 2),
    ([["O", "___", "___"],
      ["___", "O", "___"],
      ["___", "___", "___"]], 2, 2),
    ([["___", "___", "___"],
      ["O", "___", "___"],
      ["O", "___", "___"]], 0, 0),
    ([["O", "___", "___"],
      ["___", "O", "___"],
      ["___", "___", "X"]], None, None)
])
def test_find_near_win(board, x, y):
    x_idx, y_idx = Play(board=board, move_number=9, player="O").find_near_win(player="O")
    assert x_idx == x
    assert y_idx == y


@pytest.mark.parametrize("board, move_number, expected_board, expected_game_status", [
    # Opponent didnt take center
    ([["O", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 1, [["O", "___", "___"], ["___", "X", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    ([["___", "O", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 1, [["___", "O", "___"], ["___", "X", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    ([["___", "___", "O"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 1, [["___", "___", "O"], ["___", "X", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    ([["O", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 1, [["O", "___", "___"], ["___", "X", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    ([["___", "O", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 1, [["___", "O", "___"], ["___", "X", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    ([["___", "___", "O"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 1, [["___", "___", "O"], ["___", "X", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    ([["O", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 1, [["O", "___", "___"], ["___", "X", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    ([["___", "O", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 1, [["___", "O", "___"], ["___", "X", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    # Opponent takes center
    ([["___", "___", "___"],
      ["___", "O", "___"],
      ["___", "___", "___"]], 1, [["X", "___", "___"], ["___", "O", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    # Not first turn
    ([["O", "O", "___"],
      ["___", "X", "___"],
      ["___", "___", "___"]], 3, [["O", "O", "X"], ["___", "X", "___"], ["___", "___", "___"]], "IN PROGRESS"),
    ([["O", "O", "X"],
      ["O", "X", "___"],
      ["___", "___", "___"]], 5, [["O", "O", "X"], ["O", "X", "___"], ["X", "___", "___"]], "IN PROGRESS"),
    ([["O", "___", "___"],
      ["___", "X", "___"],
      ["O", "___", "___"]], 3, [["O", "___", "___"], ["X", "X", "___"], ["O", "___", "___"]], "IN PROGRESS"),
    ([["O", "___", "___"],
      ["X", "X", "O"],
      ["O", "___", "___"]], 5, [["O", "X", "___"], ["X", "X", "O"], ["O", "___", "___"]], "IN PROGRESS"),
    ([["O", "X", "___"],
      ["X", "X", "O"],
      ["O", "O", "___"]], 3, [["O", "X", "___"], ["X", "X", "O"], ["O", "O", "X"]], "IN PROGRESS"),
    ([["O", "X", "O"],
      ["X", "X", "O"],
      ["O", "O", "X"]], 3, [["O", "X", "O"], ["X", "X", "O"], ["O", "O", "X"]], "DRAW"),
    ([["O", "X", "O"],
      ["X", "X", "O"],
      ["O", "X", "X"]], 3, [["O", "X", "O"], ["X", "X", "O"], ["O", "X", "X"]], "WINNER: X"),
])
def test_calculate_next_move(board, move_number, expected_board, expected_game_status):
    resulting_board, game_status = Play(board=board, move_number=move_number, player="X").calculate_next_move()
    assert resulting_board == expected_board
    assert game_status == expected_game_status


@pytest.mark.parametrize("board, x, y", [
    ([["O", "O", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 0, 2),
    ([["O", "___", "O"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 0, 1),
    ([["___", "O", "O"],
      ["___", "___", "___"],
      ["___", "___", "___"]], 0, 0),
    ([["___", "___", "___"],
      ["O", "O", "___"],
      ["___", "___", "___"]], 1, 2),
    ([["___", "___", "___"],
      ["O", "___", "O"],
      ["___", "___", "___"]], 1, 1),
    ([["___", "___", "___"],
      ["___", "O", "O"],
      ["___", "___", "___"]], 1, 0),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["O", "O", "___"]], 2, 2),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["O", "___", "O"]], 2, 1),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["___", "O", "O"]], 2, 0),
])
def test_find_row_win(board, x, y):
    x_idx, y_idx = Play(board=board, move_number=9, player="O")._find_row_win(player="O", rows=board)
    assert x_idx == x
    assert y_idx == y


@pytest.mark.parametrize("board, x, y", [
    ([["O", "___", "___"],
      ["O", "___", "___"],
      ["___", "___", "___"]], 2, 0),
    ([["O", "___", "___"],
      ["___", "___", "___"],
      ["O", "___", "___"]], 1, 0),
    ([["___", "___", "___"],
      ["O", "___", "___"],
      ["O", "___", "___"]], 0, 0),
    ([["___", "O", "___"],
      ["___", "O", "___"],
      ["___", "___", "___"]], 2, 1),
    ([["___", "O", "___"],
      ["___", "___", "___"],
      ["___", "O", "___"]], 1, 1),
    ([["___", "___", "___"],
      ["___", "O", "___"],
      ["___", "O", "___"]], 0, 1),
    ([["___", "___", "O"],
      ["___", "___", "O"],
      ["___", "___", "___"]], 2, 2),
    ([["___", "___", "O"],
      ["___", "___", "___"],
      ["___", "___", "O"]], 1, 2),
    ([["___", "___", "___"],
      ["___", "___", "O"],
      ["___", "___", "O"]], 0, 2),
])
def test_find_column_win(board, x, y):
    columns = [[board[row][column] for row in range(0, len(board))] for column in range(0, len(board))]
    x_idx, y_idx = Play(board=board, move_number=9, player="O")._find_column_win(columns=columns, player="O")
    assert x_idx == x
    assert y_idx == y


@pytest.mark.parametrize("board, x, y", [
    ([["O", "___", "___"],
      ["___", "O", "___"],
      ["___", "___", "___"]], 2, 2),
    ([["___", "___", "___"],
      ["___", "O", "___"],
      ["___", "___", "O"]], 0, 0),
    ([["O", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "O"]], 1, 1),
    ([["___", "___", "O"],
      ["___", "O", "___"],
      ["___", "___", "___"]], 2, 0),
    ([["___", "___", "O"],
      ["___", "___", "___"],
      ["O", "___", "___"]], 1, 1),
    ([["___", "___", "___"],
      ["___", "O", "___"],
      ["O", "___", "___"]], 0, 2),
])
def test_find_diagonal_win(board, x, y):
    diagonals = [[board[x][x] for x in range(0, len(board))], [board[0][2], board[1][1], board[2][0]]]

    x_idx, y_idx = Play(board=board, move_number=9, player="O")._find_diagonal_win(diagonals, player="O")
    assert x_idx == x
    assert y_idx == y


@pytest.mark.parametrize("board", [
    ([["O", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]]),
    ([["___", "O", "___"],
      ["___", "___", "___"],
      ["___", "___", "___"]]),
    ([["___", "___", "O"],
      ["___", "___", "___"],
      ["___", "___", "___"]]),
    ([["___", "___", "___"],
      ["O", "___", "___"],
      ["___", "___", "___"]]),
    ([["___", "___", "___"],
      ["___", "O", "___"],
      ["___", "___", "___"]]),
    ([["___", "___", "___"],
      ["___", "___", "O"],
      ["___", "___", "___"]]),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["O", "___", "___"]]),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["___", "O", "___"]]),
    ([["___", "___", "___"],
      ["___", "___", "___"],
      ["___", "___", "O"]]),
])
def test_full_game(board):
    current_player = "X"
    move_number = 1
    status = ""
    while "WINNER" not in status:
        board, status = Play(board=board, move_number=9, player="X").calculate_next_move()
        if "WINNER" in status or "DRAW" in status:
            break

        if current_player == "X":
            current_player = "O"
        else:
            current_player = "X"
        move_number += 1

    assert "WINNER" in status or "DRAW" in status
    assert board
